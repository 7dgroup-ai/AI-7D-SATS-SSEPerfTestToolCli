# 请求体模板使用指南

## 概述

当测试不同的 API 接口时，不同的接口通常需要不同的请求体格式。本工具支持通过 JSON 模板文件自定义请求体格式，无需修改代码。

## 使用方法

### 基本用法

```bash
python3 sse_perfTestTool.py --host localhost --port 80 --api-key "app-xxx" \
  --api-path "/v1/chat/completions" \
  --request-body-file request_body_template_example.json
```

## 支持的变量

模板文件支持以下变量替换：

| 变量 | 说明 | 示例 |
|------|------|------|
| `{query}` | 查询文本 | "你好，请介绍一下你自己" |
| `{conversation_id}` | 对话ID | "conv-123" |
| `{user}` | 用户标识 | "gaolou" |
| `{inputs.key}` | inputs 字典中的值 | `{inputs.temperature}` → `0.7` |
| `{files}` | 文件列表（整个数组） | `[{...}]` |

## 模板示例

### 1. OpenAI 风格的接口

**文件**: `request_body_template_example.json`

```json
{
  "model": "gpt-4",
  "messages": [
    {
      "role": "user",
      "content": "{query}"
    }
  ],
  "stream": true,
  "temperature": 0.7,
  "user": "{user}"
}
```

**使用**:
```bash
python3 sse_perfTestTool.py --host api.openai.com --port 443 \
  --api-key "sk-xxx" \
  --api-path "/v1/chat/completions" \
  --request-body-file request_body_template_example.json
```

### 2. 默认格式（7DGroup 风格）

**文件**: `request_body_template_default.json`

```json
{
  "inputs": {
    "query": "{query}"
  },
  "query": "{query}",
  "response_mode": "streaming",
  "conversation_id": "{conversation_id}",
  "user": "{user}",
  "files": []
}
```

**使用**:
```bash
python3 sse_perfTestTool.py --host localhost --port 80 \
  --api-key "app-xxx" \
  --api-path "/v1/chat-messages" \
  --request-body-file request_body_template_default.json
```

### 3. Anthropic Claude 风格的接口

**文件**: `request_body_template_claude.json`（需要创建）

```json
{
  "model": "claude-3-opus-20240229",
  "max_tokens": 1024,
  "messages": [
    {
      "role": "user",
      "content": "{query}"
    }
  ],
  "stream": true,
  "user": "{user}"
}
```

### 4. 带自定义参数的接口

**文件**: `request_body_template_custom.json`（需要创建）

```json
{
  "prompt": "{query}",
  "model": "text-davinci-003",
  "temperature": 0.7,
  "max_tokens": 1000,
  "stream": true,
  "user_id": "{user}",
  "session_id": "{conversation_id}"
}
```

## 高级用法

### 嵌套结构

模板支持嵌套的 JSON 结构，变量替换是递归的：

```json
{
  "request": {
    "header": {
      "user": "{user}",
      "session": "{conversation_id}"
    },
    "body": {
      "message": "{query}",
      "options": {
        "stream": true
      }
    }
  }
}
```

### 数组中的变量

变量可以在数组中使用：

```json
{
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant."
    },
    {
      "role": "user",
      "content": "{query}"
    }
  ]
}
```

### 条件字段（通过 inputs）

如果需要在模板中使用不同的参数值，可以通过 `inputs` 传递：

```json
{
  "model": "gpt-4",
  "temperature": "{inputs.temperature}",
  "max_tokens": "{inputs.max_tokens}",
  "messages": [
    {
      "role": "user",
      "content": "{query}"
    }
  ]
}
```

然后在代码中，可以通过修改 `test_streaming()` 方法的 `inputs` 参数来传递这些值。

## 注意事项

1. **模板文件格式**: 必须是有效的 JSON 格式
2. **变量替换**: 变量替换是字符串替换，不支持表达式计算
3. **默认值**: 如果不指定 `--request-body-file`，工具使用默认的请求体格式
4. **错误处理**: 如果模板文件加载失败，工具会回退到默认格式并显示警告
5. **响应格式**: 不同的 API 可能有不同的响应格式，如果响应中的字段名不同（例如不是 `answer`），可能需要修改 `tester.py` 中的响应解析逻辑

## 故障排查

### 模板文件加载失败

如果看到警告信息：
```
警告: 请求体模板文件 'xxx.json' 不存在
```

**解决方法**:
- 检查文件路径是否正确
- 确认文件存在且可读
- 检查文件权限

### JSON 解析错误

如果看到警告信息：
```
警告: 请求体模板文件 'xxx.json' JSON 解析失败
```

**解决方法**:
- 使用 JSON 验证工具检查文件格式
- 确保所有引号、括号、逗号都正确
- 检查是否有注释（JSON 不支持注释）

### 变量未替换

如果发现变量没有被替换：

**解决方法**:
- 确认变量名拼写正确（区分大小写）
- 检查变量是否在支持的变量列表中
- 确认变量格式正确（例如 `{query}` 而不是 `{{query}}`）

## 最佳实践

1. **模板文件命名**: 使用描述性的文件名，例如 `request_body_template_openai.json`
2. **版本控制**: 将模板文件纳入版本控制
3. **文档化**: 为每个模板文件添加注释说明（在单独的文档中）
4. **测试**: 先用单个请求测试模板是否正确，再进行压测
5. **备份**: 保留原始模板文件的备份
